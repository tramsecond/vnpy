# 回测策略总结文档

本文档总结了项目中三个不同的回测策略，包括策略逻辑、交易规则和输出结果。

---

## 策略概览

| 策略文件 | 策略名称 | 核心特点 | 适用周期 |
|---------|---------|---------|---------|
| `trade_test1.py` | 基础信号策略 | 严格按照买入/卖出信号执行 | 日线、周线、月线 |
| `trade_test1_new_strategy.py` | 价格变化策略 | 结合信号和价格变化（止盈止损） | 日线、周线、月线 |
| `trade_test2.py` | 多周期筛选策略 | 需要多个周期同时确认 | 日线+周线+月线 |

---

## 一、基础信号策略 (trade_test1.py)

### 策略描述
最简单的信号跟随策略，严格按照技术指标产生的买入/卖出信号执行交易。

### 交易规则

#### 买入条件
- **触发条件**：当前周期出现买入信号（`综合判断` 在 `BUY_SIGNALS` 中）
- **执行价格**：使用**下一天的开盘价**买入
- **前提条件**：
  - 账户有现金（`cash > 0`）
  - 当前无持仓（`position == 0`）
  - 不是最后一行数据

#### 卖出条件
- **触发条件**：当前周期出现卖出信号（`综合判断` 在 `SELL_SIGNALS` 中）
- **执行价格**：使用**下一天的开盘价**卖出
- **前提条件**：
  - 当前有持仓（`position > 0`）
  - 不是最后一行数据

### 策略特点
- ✅ **简单直接**：完全跟随信号，无需额外判断
- ✅ **执行延迟**：使用下一天开盘价，更接近实际交易
- ⚠️ **无止损止盈**：完全依赖信号，可能错过最佳卖出时机
- ⚠️ **单周期依赖**：只考虑当前周期的信号

### 输出结果
- 回测统计（初始资金、最终资产、胜率、涨幅、年化涨幅等）
- 交易记录（买入/卖出时间、价格、盈亏）
- 资产净值曲线
- 周期汇总报告

---

## 二、价格变化策略 (trade_test1_new_strategy.py)

### 策略描述
在基础信号策略的基础上，增加了价格变化触发的止盈止损机制，更灵活地管理持仓。

### 交易规则

#### 买入条件
- **触发条件**：当前周期出现买入信号（`综合判断` 在 `BUY_SIGNALS` 中）
- **执行价格**：使用**下一天的开盘价**买入
- **前提条件**：与基础策略相同

#### 卖出条件（多重判断）
卖出逻辑按优先级执行：

1. **信号卖出**（最高优先级）
   - 如果当前信号为看空（`综合判断` 在 `SELL_SIGNALS` 中）
   - 立即卖出
   - 执行价格：**当前收盘价**

2. **价格变化卖出**（次优先级）
   - 如果当前信号**不是**看多（`综合判断` 不在 `BUY_SIGNALS` 中）
   - 检查价格变化：
     - **上涨 ≥ 10%**：止盈卖出
     - **下跌 ≤ -5%**：止损卖出
   - 执行价格：**当前收盘价**

3. **持仓管理**
   - 如果信号为看多，且价格变化在 -5% 到 10% 之间，继续持仓

### 策略特点
- ✅ **止盈止损**：自动锁定利润，控制亏损
- ✅ **灵活卖出**：使用收盘价，可当日执行
- ✅ **风险控制**：5%止损线保护本金
- ⚠️ **单周期依赖**：只考虑当前周期的信号
- ⚠️ **参数固定**：止盈10%、止损5%为固定值

### 关键参数
- **止盈阈值**：+10%
- **止损阈值**：-5%

### 输出结果
- 回测统计（包含卖出原因统计）
- 交易记录（包含卖出原因字段）
- 资产净值曲线
- 新策略汇总报告

---

## 三、多周期筛选策略 (trade_test2.py)

### 策略描述
最严格的筛选策略，需要日线、周线、月线三个周期同时确认才能买入，任意周期出现卖出信号即卖出。

### 交易规则

#### 买入条件（三重验证）
必须**同时满足**以下所有条件：

1. **日线条件**：日线出现买入信号（`综合判断` 在 `BUY_SIGNALS` 中）
2. **周线条件**：周线出现买入信号
   - 查找当前日期之前最近的周结束日期
   - 该周结束日期的信号必须为买入信号
3. **月线条件**：月线**不是**卖出信号
   - 查找当前日期之前最近的月结束日期
   - 该月结束日期的信号**不能**为卖出信号

**执行价格**：使用**下一天的开盘价**买入

#### 卖出条件（任意周期触发）
只要**任意一个周期**出现卖出信号即卖出：

1. **日线卖出**：日线出现卖出信号 → 立即卖出
2. **周线卖出**：周线出现卖出信号 → 立即卖出
3. **月线卖出**：月线出现卖出信号 → 立即卖出

**执行价格**：使用**下一天的开盘价**卖出

**信号来源记录**：记录是哪个周期触发的卖出信号

### 策略特点
- ✅ **严格筛选**：三重验证减少假信号
- ✅ **快速止损**：任意周期卖出信号即退出
- ✅ **多周期确认**：提高买入信号质量
- ⚠️ **交易频率低**：买入条件严格，可能错过机会
- ⚠️ **信号查找**：需要查找最近的周/月结束日期

### 特殊功能
- **持股天数统计**：记录每次交易的持股天数
- **平均持股天数**：计算平均持仓时间
- **日均收益率**：计算平均每日收益率

### 输出结果
- 回测统计（包含持股天数相关指标）
- 交易记录（包含信号来源、持股天数）
- 资产净值曲线
- 多周期策略汇总报告

---

## 策略对比

### 买入条件对比

| 策略 | 买入条件 | 严格程度 |
|-----|---------|---------|
| 基础信号策略 | 单周期买入信号 | ⭐⭐ |
| 价格变化策略 | 单周期买入信号 | ⭐⭐ |
| 多周期筛选策略 | 日线买入 + 周线买入 + 月线非卖出 | ⭐⭐⭐⭐⭐ |

### 卖出条件对比

| 策略 | 卖出条件 | 灵活性 |
|-----|---------|--------|
| 基础信号策略 | 单周期卖出信号 | ⭐⭐ |
| 价格变化策略 | 卖出信号 或 价格变化（±10%/-5%） | ⭐⭐⭐⭐ |
| 多周期筛选策略 | 任意周期卖出信号 | ⭐⭐⭐ |

### 执行价格对比

| 策略 | 买入价格 | 卖出价格 |
|-----|---------|---------|
| 基础信号策略 | 下一天开盘价 | 下一天开盘价 |
| 价格变化策略 | 下一天开盘价 | 当前收盘价 |
| 多周期筛选策略 | 下一天开盘价 | 下一天开盘价 |

---

## 适用场景

### 基础信号策略 (trade_test1.py)
- ✅ 适合测试技术指标信号的纯有效性
- ✅ 适合快速回测和对比
- ✅ 适合信号质量较高的市场环境
- ❌ 不适合波动较大的市场（无止损保护）

### 价格变化策略 (trade_test1_new_strategy.py)
- ✅ 适合需要风险控制的市场
- ✅ 适合追求稳定收益的策略
- ✅ 适合波动较大的市场（有止盈止损）
- ❌ 可能错过大幅上涨机会（10%止盈）

### 多周期筛选策略 (trade_test2.py)
- ✅ 适合追求高质量交易机会
- ✅ 适合减少假信号干扰
- ✅ 适合中长期投资策略
- ❌ 交易频率较低，可能错过短期机会

---

## 输出文件说明

### 基础信号策略输出
- **目录**：`backtest_results/`
- **文件格式**：`{股票代码}_回测结果.xlsx`
- **工作表**：
  - 回测统计
  - {周期}交易记录
  - {周期}资产净值
- **汇总报告**：`回测总结报告.xlsx`

### 价格变化策略输出
- **目录**：`backtest_results_new_strategy/`
- **文件格式**：`{股票代码}_新策略_回测结果.xlsx`
- **工作表**：
  - 回测统计
  - {周期}交易记录（包含卖出原因）
- **汇总报告**：`新策略汇总报告_{时间戳}.xlsx`

### 多周期筛选策略输出
- **目录**：`backtest_results_multi_period/`
- **文件格式**：`{股票代码}_多周期策略_回测结果.xlsx`
- **工作表**：
  - 交易记录（包含信号来源、持股天数）
  - 资产净值
- **汇总报告**：`多周期策略_回测总结报告.xlsx`

---

## 统计指标说明

### 通用指标
- **初始资金**：回测起始资金（默认100,000）
- **最终资产净值**：回测结束时的总资产
- **涨幅**：收益率（百分比形式，如0.5表示50%）
- **年化涨幅**：年化收益率
- **胜率**：盈利交易次数 / 总交易次数
- **交易次数**：总交易次数
- **盈利交易次数**：盈利的交易次数
- **回测开始价格**：回测期间第一天的收盘价
- **回测结束价格**：回测期间最后一天的收盘价
- **回测期间涨跌幅**：价格的自然涨跌幅（用于对比策略表现）

### 多周期策略特有指标
- **总持股天数**：所有交易的总持股天数
- **平均持股天数**：平均每次交易的持股天数
- **日均收益率(%)**：平均每日收益率

---

## 使用建议

1. **初次测试**：建议先使用基础信号策略，了解信号质量
2. **风险控制**：如果基础策略亏损较大，尝试价格变化策略
3. **质量优先**：如果追求高质量交易，使用多周期筛选策略
4. **参数优化**：价格变化策略的止盈止损阈值可根据实际情况调整
5. **周期选择**：不同周期可能适合不同策略，建议分别测试

---

## 注意事项

1. **数据质量**：确保输入数据包含 `综合判断` 列
2. **价格验证**：所有策略都会过滤负数价格数据
3. **日期范围**：如果检测到负数价格，会自动过滤 `BACKTEST_START_DATE` 之前的数据
4. **持仓处理**：回测结束时未卖出的持仓会按最后一天收盘价计算
5. **信号定义**：买入/卖出信号由 `config.py` 中的 `BUY_SIGNALS` 和 `SELL_SIGNALS` 定义

---

## 更新记录

- **2024-XX-XX**：创建文档，总结三个回测策略
- **2024-XX-XX**：移除小时线相关功能，仅支持日线、周线、月线

