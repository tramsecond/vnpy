# 📊 股票数据分段处理系统使用说明

## 🎯 功能概述

本系统支持**一次性运行**所有股票数据，通过智能分段处理机制避免脚本卡住，并提供断点续传功能。

## 🚀 运行方式

### 方式1：只处理股票数据（推荐）
```bash
python data_preparation.py --stocks-only
```

### 方式2：处理股票和指数数据
```bash
python data_preparation.py
```

## 📦 分段处理机制

### 批次配置
- **批次大小**: 每批处理 20 只股票
- **批次间隔**: 每批之间休息 10 秒
- **股票间隔**: 每只股票之间休息 3 秒

### 智能休息策略
- 避免 API 限流
- 减少网络拥堵
- 提高整体成功率

## 🔄 断点续传功能

### 自动进度保存
- 每处理完一只股票自动保存进度
- 进度文件：`stock_processing_progress.json`（仅股票模式）
- 进度文件：`processing_progress.json`（完整模式）

### 断点续传使用
1. 如果脚本中断，重新运行即可
2. 系统自动检测进度文件
3. 从上次停止的地方继续处理
4. 处理完成后自动清理进度文件

## 📊 进度监控

### 实时显示信息
- 当前处理进度（第X只/总共Y只）
- 已用时间和预计剩余时间
- 每只股票的处理状态和耗时
- 批次完成统计

### 进度示例
```
📦 批次 1/15: 处理第 1-20 只股票
📊 本批次: 20 只股票
============================================================

📈 [1/300] (0.3%) 处理股票: 平安银行(sz000001)
⏱️  已用时间: 5.2秒 | 预计剩余: 2598.8秒
  📥 拉取 sz000001 的日数据...
  ✅ 成功获取 1234 条日线数据
  📥 拉取 sz000001 的60分钟数据...
  ✅ 成功获取 5678 条60分钟数据
✅ 股票 平安银行 处理成功，耗时: 12.34秒
⏸️  休息 3 秒...

✅ 批次 1 完成! 本批次用时: 245.67秒
⏸️  批次间休息 10 秒...
```

## ⚠️ 注意事项

### 网络环境
- 确保网络连接稳定
- 避免在高峰期运行（如开盘、收盘时间）
- 如果网络不稳定，可以适当增加休息时间

### 系统资源
- 确保有足够的磁盘空间存储数据
- 建议在性能较好的机器上运行
- 避免同时运行其他占用网络资源的程序

### 中断处理
- 脚本支持 Ctrl+C 中断
- 中断后重新运行即可继续
- 进度文件会自动保存，无需担心数据丢失

## 🔧 自定义配置

如需调整分段处理参数，可以修改以下变量：

```python
# 在 main_stocks_only() 函数中
BATCH_SIZE = 20          # 批次大小
BATCH_REST_TIME = 10     # 批次间隔（秒）
STOCK_REST_TIME = 3      # 股票间隔（秒）
```

## 📈 性能优化建议

### 提高成功率
- 在网络稳定时运行
- 避免同时运行多个实例
- 定期清理临时文件

### 提高速度
- 可以适当减少休息时间（但不建议低于2秒）
- 在低峰期运行
- 使用性能较好的网络环境

## 🎉 成功标志

当看到以下信息时，表示处理完成：
```
🎉 所有股票都处理成功！

📁 数据保存位置
============================================================
📈 股票数据: 'stock_data' 目录
🕐 完成时间: 2024-01-01 12:00:00
============================================================
```

## 🆘 故障排除

### 常见问题
1. **脚本卡住**: 检查网络连接，适当增加休息时间
2. **进度文件损坏**: 删除进度文件，重新开始
3. **API 限流**: 增加休息时间，分批处理

### 联系支持
如遇到其他问题，请检查：
- 网络连接状态
- 磁盘空间是否充足
- 是否有其他程序占用网络资源

---

**祝您使用愉快！** 🚀
