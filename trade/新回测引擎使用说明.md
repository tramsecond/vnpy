# 📊 新回测引擎使用说明

> **版本**: 1.0  
> **创建日期**: 2026-01-09  
> **参考框架**: VeighNa CtaBacktester  

---

## 🎯 项目背景

基于你现有的交易系统，参考 VeighNa 框架的设计理念，创建了一套改进的回测引擎。该引擎保持与你现有 Excel 数据格式的兼容性，同时提供了更专业的回测功能。

### ✨ 核心特性

- ✅ **兼容现有数据**：直接读取你的 Excel 技术指标数据
- ✅ **策略模板化**：类似 VeighNa 的策略开发模式
- ✅ **参数优化**：自动寻找最佳参数组合
- ✅ **可视化分析**：丰富的图表展示
- ✅ **批量回测**：支持多策略、多标的对比
- ✅ **专业指标**：夏普比率、最大回撤、胜率等

---

## 📁 文件结构

```
trade/
├── backtest_engine.py          # 回测引擎核心
├── backtest_examples.py        # 使用示例
├── backtest_visualizer.py      # 可视化工具
├── 新回测引擎使用说明.md       # 本文档
└── backtest_results_new_engine/  # 回测结果输出目录（自动创建）
```

---

## 🚀 快速开始

### 1. 安装依赖

确保已安装以下 Python 包：

```bash
pip install pandas numpy matplotlib xlsxwriter openpyxl
```

### 2. 运行示例

```bash
python backtest_examples.py
```

选择要运行的示例：
- 1. 单策略回测
- 2. 参数优化
- 3. 多策略对比
- 4. 批量回测多只股票

---

## 📚 核心概念

### 回测引擎 (BacktestEngine)

回测引擎是整个系统的核心，负责：
- 加载 Excel 数据
- 执行策略逻辑
- 订单撮合和持仓管理
- 统计分析和结果输出

### 策略模板 (StrategyTemplate)

所有策略必须继承 `StrategyTemplate` 并实现以下方法：

```python
class MyStrategy(StrategyTemplate):
    def on_init(self):
        """初始化策略（可选）"""
        pass
    
    def on_bar(self, bar: BarData):
        """处理每根K线（必须实现）"""
        pass
    
    def on_stop(self):
        """策略结束（可选）"""
        pass
```

---

## 💡 使用示例

### 示例 1: 简单的双均线策略

```python
from backtest_engine import BacktestEngine, StrategyTemplate, BarData

class DualMAStrategy(StrategyTemplate):
    """双均线策略"""
    
    def on_init(self):
        self.fast_period = self.params.get('fast_period', 5)
        self.slow_period = self.params.get('slow_period', 20)
    
    def on_bar(self, bar: BarData):
        # 获取均线值
        fast_ma = self.get_indicator(f'MA{self.fast_period}')
        slow_ma = self.get_indicator(f'MA{self.slow_period}')
        
        if fast_ma is None or slow_ma is None:
            return
        
        # 计算可买入数量
        volume = int(self.engine.capital * 0.8 / bar.close / 100) * 100
        
        # 交易逻辑
        if self.pos == 0:  # 空仓
            if fast_ma > slow_ma and volume > 0:
                self.buy(bar.close, volume)  # 金叉买入
        else:  # 持仓
            if fast_ma < slow_ma:
                self.sell(bar.close, self.pos)  # 死叉卖出

# 创建回测引擎
engine = BacktestEngine(
    strategy_class=DualMAStrategy,
    symbol="000651",
    data_path="analyzed_results/000651_格力电器_技术数据.xlsx",
    start_date="2022-01-01",
    end_date="2024-12-31",
    initial_capital=100000,
    commission_rate=0.0003
)

# 加载数据并运行回测
if engine.load_data(sheet_name="日线"):
    results = engine.run_backtest(strategy_params={
        'fast_period': 5,
        'slow_period': 20
    })
    
    # 打印结果
    print(f"总收益率: {results['总收益率(%)']}%")
    print(f"最大回撤: {results['最大回撤(%)']}%")
    print(f"夏普比率: {results['夏普比率']}")
```

### 示例 2: SuperTrend 趋势策略

```python
class SuperTrendStrategy(StrategyTemplate):
    """SuperTrend趋势跟踪策略"""
    
    def on_init(self):
        self.stop_loss_pct = self.params.get('stop_loss_pct', 5.0)
        self.profit_take_pct = self.params.get('profit_take_pct', 10.0)
        self.entry_price = 0.0
    
    def on_bar(self, bar: BarData):
        # 获取SuperTrend信号
        signal = self.get_indicator('SuperTrend_信号')
        
        if signal is None:
            return
        
        volume = int(self.engine.capital * 0.8 / bar.close / 100) * 100
        
        if self.pos == 0:  # 空仓
            if signal == '看多' and volume > 0:
                self.buy(bar.close, volume)
                self.entry_price = bar.close
        else:  # 持仓
            # 止损
            loss_pct = (bar.close - self.entry_price) / self.entry_price * 100
            if loss_pct <= -self.stop_loss_pct:
                self.sell(bar.close, self.pos)
                return
            
            # 止盈
            profit_pct = (bar.close - self.entry_price) / self.entry_price * 100
            if profit_pct >= self.profit_take_pct:
                self.sell(bar.close, self.pos)
                return
            
            # 信号卖出
            if signal == '看空':
                self.sell(bar.close, self.pos)
```

### 示例 3: 参数优化

```python
# 定义参数范围
param_ranges = {
    'fast_period': [5, 10, 15, 20],
    'slow_period': [20, 30, 60, 120]
}

# 运行优化（自动测试所有组合）
optimization_results = engine.optimize_parameters(
    param_ranges=param_ranges,
    target_metric='夏普比率',  # 优化目标
    optimize_mode='max'         # 最大化
)

# 查看最佳参数
best_result = optimization_results[0]
print(f"最佳参数: {best_result['参数']}")
print(f"夏普比率: {best_result['夏普比率']}")
```

### 示例 4: 多策略对比

```python
from backtest_visualizer import compare_strategies

strategies = [
    (DualMAStrategy, {'fast_period': 5, 'slow_period': 20}, "双均线"),
    (SuperTrendStrategy, {'stop_loss_pct': 5}, "SuperTrend"),
]

all_results = []
for strategy_class, params, name in strategies:
    engine = BacktestEngine(
        strategy_class=strategy_class,
        symbol="000651",
        data_path="analyzed_results/000651_格力电器_技术数据.xlsx",
        start_date="2022-01-01",
        end_date="2024-12-31",
        initial_capital=100000
    )
    
    if engine.load_data(sheet_name="日线"):
        results = engine.run_backtest(strategy_params=params)
        results['策略名称'] = name
        all_results.append(results)

# 可视化对比
compare_strategies(all_results, "策略对比.png")
```

---

## 🎨 可视化功能

### 单策略可视化

```python
from backtest_visualizer import visualize_backtest_results
from backtest_engine import save_backtest_results

# 运行回测
results = engine.run_backtest()

# 保存Excel结果
save_backtest_results(results, "回测结果.xlsx")

# 生成可视化图表（包含6个子图）
visualize_backtest_results(results, "回测可视化.png")
```

可视化图表包含：
1. **资金曲线**：展示资产变化趋势
2. **累计收益率**：收益率随时间变化
3. **回撤曲线**：最大回撤分析
4. **持仓价值**：持仓市值变化
5. **统计摘要**：关键指标汇总
6. **月度收益热力图**：每月收益表现

### 策略对比可视化

```python
from backtest_visualizer import compare_strategies

# all_results 是多个策略的回测结果列表
compare_strategies(all_results, "策略对比.png")
```

对比图表包含：
1. **资金曲线对比**：多策略资产曲线
2. **收益率对比**：累计收益率比较
3. **关键指标对比**：柱状图对比
4. **胜率和交易次数**：双Y轴对比

### 参数优化可视化

```python
from backtest_visualizer import plot_optimization_results

# optimization_results 是参数优化结果
plot_optimization_results(
    optimization_results,
    param_names=['fast_period', 'slow_period'],
    target_metric='夏普比率',
    output_path="参数优化.png"
)
```

---

## 📊 回测指标说明

### 基础指标

| 指标 | 说明 | 计算方式 |
|------|------|----------|
| **总收益率** | 总体收益百分比 | (最终资金 - 初始资金) / 初始资金 × 100% |
| **年化收益率** | 按年计算的收益率 | ((最终资金 / 初始资金) ^ (365 / 天数) - 1) × 100% |
| **最大回撤** | 资金最大跌幅 | max((峰值资金 - 当前资金) / 峰值资金) × 100% |

### 风险指标

| 指标 | 说明 | 优秀值 |
|------|------|--------|
| **夏普比率** | 风险调整后收益 | > 1.0 |
| **胜率** | 盈利交易占比 | > 50% |
| **盈亏比** | 平均盈利/平均亏损 | > 1.5 |

### 交易统计

- **交易次数**：完整买卖次数
- **盈利次数**：盈利的交易数量
- **亏损次数**：亏损的交易数量
- **持有天数**：平均持仓时间

---

## ⚙️ 高级配置

### 回测引擎参数

```python
engine = BacktestEngine(
    strategy_class=MyStrategy,       # 策略类
    symbol="000651",                  # 股票代码
    data_path="path/to/data.xlsx",   # 数据文件路径
    start_date="2022-01-01",         # 回测开始日期
    end_date="2024-12-31",           # 回测结束日期
    initial_capital=100000,           # 初始资金
    commission_rate=0.0003,           # 手续费率（万三）
    slippage=0.01,                    # 滑点（元）
    size_multiplier=1,                # 合约乘数（股票为1）
    price_tick=0.01                   # 最小价格变动
)
```

### 数据周期选择

```python
# 支持多个周期
engine.load_data(sheet_name="日线")    # 日线数据
engine.load_data(sheet_name="周线")    # 周线数据
engine.load_data(sheet_name="月线")    # 月线数据
engine.load_data(sheet_name="小时线")  # 小时线数据
```

---

## 🔧 策略开发技巧

### 1. 获取技术指标

```python
def on_bar(self, bar: BarData):
    # 方法1：使用get_indicator
    ma5 = self.get_indicator('MA5')
    ma20 = self.get_indicator('MA20')
    macd = self.get_indicator('MACD')
    
    # 方法2：直接访问indicators字典
    rsi = bar.indicators.get('RSI14')
    kdj_j = bar.indicators.get('KDJ_J')
```

### 2. 资金管理

```python
def on_bar(self, bar: BarData):
    # 使用80%资金
    available_capital = self.engine.capital * 0.8
    
    # 计算可买入数量（整百股）
    volume = int(available_capital / bar.close / 100) * 100
    
    # 固定数量
    volume = 1000  # 买入1000股
```

### 3. 风险控制

```python
def on_init(self):
    self.stop_loss_pct = 5.0    # 止损5%
    self.profit_take_pct = 10.0  # 止盈10%
    self.entry_price = 0.0

def on_bar(self, bar: BarData):
    if self.pos > 0:
        # 止损
        loss_pct = (bar.close - self.entry_price) / self.entry_price * 100
        if loss_pct <= -self.stop_loss_pct:
            self.sell(bar.close, self.pos)
        
        # 止盈
        profit_pct = (bar.close - self.entry_price) / self.entry_price * 100
        if profit_pct >= self.profit_take_pct:
            self.sell(bar.close, self.pos)
```

### 4. 多条件组合

```python
def on_bar(self, bar: BarData):
    # 获取多个指标
    ma5 = self.get_indicator('MA5')
    ma20 = self.get_indicator('MA20')
    rsi = self.get_indicator('RSI14')
    volume = bar.indicators.get('成交量', 0)
    
    # 组合条件
    if (ma5 > ma20 and          # 均线多头
        rsi < 30 and             # RSI超卖
        volume > 1000000):       # 成交量放大
        
        # 满足所有条件才买入
        if self.pos == 0:
            self.buy(bar.close, 1000)
```

---

## 📈 与原有回测脚本的对比

| 特性 | 原有脚本 | 新回测引擎 |
|------|---------|-----------|
| **数据来源** | Excel直接读取 | Excel + 结构化封装 |
| **策略开发** | 函数式 | 面向对象（类似VeighNa） |
| **参数优化** | 手动修改 | 自动化网格搜索 |
| **回测指标** | 基础指标 | 专业指标（夏普比率等） |
| **可视化** | 基础图表 | 6图详细分析 |
| **策略对比** | 不支持 | 支持多策略对比 |
| **代码复用** | 低 | 高（策略模板） |
| **扩展性** | 一般 | 强（参考VeighNa设计） |

---

## 🎯 实战建议

### 1. 策略开发流程

```
1. 在纸上设计策略逻辑
   ↓
2. 继承StrategyTemplate实现策略
   ↓
3. 使用小数据集快速测试
   ↓
4. 参数优化寻找最佳参数
   ↓
5. 多标的验证策略稳定性
   ↓
6. 多策略对比选择最优
```

### 2. 参数优化技巧

- 先粗调（大范围、大步长）
- 再精调（小范围、小步长）
- 避免过度拟合（样本外测试）
- 考虑多个目标（收益+风险）

### 3. 回测陷阱

⚠️ **避免未来函数**：不能使用未来数据  
⚠️ **滑点和手续费**：必须考虑交易成本  
⚠️ **样本选择偏差**：不要只测试牛市数据  
⚠️ **过度优化**：参数过多容易过拟合  

---

## 🔍 故障排除

### 问题1：数据加载失败

```
错误：Excel文件中没有'日期'列
```

**解决**：确保Excel文件中有"日期"列，且格式正确

### 问题2：指标值为None

```python
# 原因：指标名称不匹配或数据中没有该指标
ma5 = self.get_indicator('MA5')  # 返回None

# 解决：检查Excel中的列名
# 如果列名是"MA_5"，则使用：
ma5 = self.get_indicator('MA_5')
```

### 问题3：可视化中文乱码

```python
# 在代码开头添加：
import matplotlib.pyplot as plt
plt.rcParams['font.sans-serif'] = ['SimHei', 'Microsoft YaHei']
plt.rcParams['axes.unicode_minus'] = False
```

---

## 📞 获取帮助

### 查看示例代码

所有示例都在 `backtest_examples.py` 中，包含：
- 单策略回测
- 参数优化
- 多策略对比
- 批量回测

### 运行示例

```bash
python backtest_examples.py
```

然后选择相应的示例运行。

---

## 🚀 下一步计划

### 已完成 ✅
- [x] 核心回测引擎
- [x] 策略模板系统
- [x] 参数优化功能
- [x] 可视化工具
- [x] 示例策略

### 可扩展功能
- [ ] 多标的组合策略
- [ ] 期货合约支持
- [ ] 实时数据接口（可选）
- [ ] 策略绩效归因分析
- [ ] 更多优化算法（遗传算法等）

---

## 💪 总结

这套新的回测引擎：

1. **保持兼容**：直接使用你现有的Excel数据
2. **提升专业性**：参考VeighNa的设计理念
3. **易于扩展**：面向对象的架构设计
4. **功能丰富**：参数优化、可视化、批量回测
5. **快速上手**：丰富的示例代码

**建议使用方式**：
- 继续使用现有脚本进行数据准备
- 使用新回测引擎进行策略研究和优化
- 后期可根据需要进一步扩展功能

---

**祝你交易顺利！** 🎉

---

*文档版本: 1.0*  
*最后更新: 2026-01-09*
