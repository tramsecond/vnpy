# 小时数据功能说明

## 概述

本次更新为 `data_preparation.py` 和 `data_index_preparation_improved.py` 两个文件添加了小时级别的数据处理功能，并在Excel输出中创建独立的"小时线数据"页签。

## 新增功能

### 1. 小时数据生成函数

#### `generate_hourly_view(df)`
- **功能**: 将日线数据重采样为小时线数据
- **参数**: `df` - 包含OHLCV数据的DataFrame
- **返回**: 小时线数据的DataFrame
- **特点**: 
  - 使用 `resample('H')` 进行小时级重采样
  - 自动处理开盘价、最高价、最低价、收盘价和成交量
  - 删除空值数据

### 2. Excel输出增强

#### 页签顺序
Excel文件现在包含以下页签（按顺序排列）：
1. **日线数据** - 原始日线数据
2. **小时线数据** - 新增的小时线数据 ⭐
3. **周线数据** - 周线数据
4. **月线数据** - 月线数据

#### 函数签名更新
```python
# 更新前
def save_data_to_excel(df_daily, df_weekly, df_monthly, filename)

# 更新后  
def save_data_to_excel(df_daily, df_weekly, df_monthly, df_hourly, filename)
```

### 3. 技术指标计算

小时线数据同样支持所有技术指标的计算：
- 移动平均线 (MA)
- 指数移动平均线 (EMA)
- MACD指标
- KDJ指标
- RSI指标
- 布林带指标
- Trend Indicator A-V2
- SuperTrend指标
- QQE MOD指标

## 文件修改详情

### `data_preparation.py`
- ✅ 新增 `generate_hourly_view()` 函数
- ✅ 更新 `save_data_to_excel()` 函数签名
- ✅ 在 `process_and_save_data()` 中添加小时数据生成流程
- ✅ 更新函数调用以包含小时数据参数

### `data_index_preparation_improved.py`
- ✅ 新增 `generate_hourly_view()` 函数
- ✅ 更新 `save_data_to_excel()` 函数签名
- ✅ 在数据处理流程中添加小时数据生成
- ✅ 更新函数调用以包含小时数据参数

## 使用方法

### 自动使用
当运行股票或指数数据准备脚本时，系统会自动：
1. 生成小时线数据
2. 计算小时线技术指标
3. 保存到Excel文件的"小时线数据"页签

### 手动调用
```python
from data_preparation import generate_hourly_view

# 生成小时线数据
df_hourly = generate_hourly_view(df_daily.copy())

# 保存到Excel（包含小时数据）
save_data_to_excel(df_daily, df_weekly, df_monthly, df_hourly, filename)
```

## 数据格式

### 输入数据要求
- 必须包含 `date` 列（日期时间格式）
- 必须包含 `open`, `high`, `low`, `close`, `volume` 列
- 日期列应为pandas datetime类型

### 输出数据格式
小时线数据保持与输入数据相同的列结构，但时间粒度变为小时级别。

## 注意事项

1. **数据量**: 小时线数据量通常比日线数据量大，请注意内存使用
2. **交易时间**: 当前实现按小时重采样，未过滤非交易时间
3. **向后兼容**: 所有现有功能保持不变，新增功能为可选
4. **性能**: 小时数据生成会增加一定的处理时间

## 测试验证

功能已通过以下测试验证：
- ✅ 小时数据生成功能正常
- ✅ Excel保存功能正常
- ✅ 小时线数据页签创建成功
- ✅ 两个文件的功能一致性验证

## 更新日志

- **2024-01-XX**: 新增小时数据功能
  - 添加 `generate_hourly_view()` 函数
  - 更新Excel输出格式
  - 集成到现有数据处理流程
  - 添加技术指标计算支持
