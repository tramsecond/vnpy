# 多标的回测使用说明

VeighNa支持一个策略同时对多个标的进行回测，有两种方式：

## 方式一：使用脚本批量回测（推荐）

我已经为你创建了 `multi_symbol_backtest.py` 脚本，可以同时对多个标的进行回测并汇总结果。

### 使用方法

1. **修改配置**：编辑 `multi_symbol_backtest.py`，设置要回测的标的：

```python
SYMBOLS = [
    ("000001", "SSE", "上证指数"),
    ("399001", "SZSE", "深证成指"),
    ("399006", "SZSE", "创业板指"),
    ("000688", "SSE", "科创50"),
    ("899050", "BSE", "北证50"),
]
```

2. **修改回测参数**：

```python
INTERVAL = Interval.DAILY  # 周期
START_DATE = datetime(2020, 1, 2)  # 开始日期
END_DATE = datetime(2026, 1, 7)  # 结束日期
RATE = 0.0003  # 手续费率
CAPITAL = 1_000_000  # 回测资金
```

3. **修改策略参数**：

```python
STRATEGY_SETTING = {}  # 策略参数，例如：{"atr_length": 14, "rsi_length": 14}
```

4. **运行脚本**：

```bash
python multi_symbol_backtest.py
```

### 工作原理

- 脚本会对每个标的分别运行回测
- 然后将所有标的的盈亏结果按日期对齐并相加
- 最后计算组合的统计指标并显示图表

### 优点

- ✅ 不需要安装额外模块
- ✅ 可以灵活控制每个标的的参数
- ✅ 结果汇总简单直观

---

## 方式二：使用Portfolio Strategy模块（需要安装）

如果你需要更专业的组合策略回测（如配对交易、统计套利等），可以使用 `vnpy_portfoliostrategy` 模块。

### 安装

```bash
pip install vnpy_portfoliostrategy
```

### 使用示例

```python
from datetime import datetime
from vnpy_portfoliostrategy import BacktestingEngine
from vnpy.trader.constant import Interval
from vnpy_portfoliostrategy.strategies.pair_trading_strategy import PairTradingStrategy

engine = BacktestingEngine()
engine.set_parameters(
    vt_symbols=["000001.SSE", "399001.SZSE"],  # 多标的列表
    interval=Interval.DAILY,
    start=datetime(2020, 1, 1),
    end=datetime(2026, 1, 7),
    rates={
        "000001.SSE": 0.0003,
        "399001.SZSE": 0.0003
    },
    slippages={
        "000001.SSE": 0,
        "399001.SZSE": 0
    },
    sizes={
        "000001.SSE": 1,
        "399001.SZSE": 1
    },
    priceticks={
        "000001.SSE": 0.01,
        "399001.SZSE": 0.01
    },
    capital=1_000_000,
)

setting = {
    "boll_window": 20,
    "boll_dev": 1,
}
engine.add_strategy(PairTradingStrategy, setting)

engine.load_data()
engine.run_backtesting()
df = engine.calculate_result()
engine.calculate_statistics()
engine.show_chart()
```

### 优点

- ✅ 原生支持多标的
- ✅ 支持组合策略（如配对交易）
- ✅ 可以同时交易多个标的

### 缺点

- ❌ 需要额外安装模块
- ❌ 策略类型有限（主要是组合策略）

---

## 推荐方案

对于你的需求（一个CTA策略同时对多个标的进行回测），**推荐使用方式一（脚本批量回测）**，因为：

1. 不需要安装额外模块
2. 可以灵活使用任何CTA策略
3. 结果汇总简单直观
4. 可以分别查看每个标的的表现

---

## 注意事项

1. **数据准备**：确保所有标的的数据都已导入到VeighNa数据库中
2. **日期对齐**：不同标的的数据日期可能不完全一致，脚本会自动处理
3. **资金分配**：当前脚本假设每个标的使用相同的资金，实际可以根据需要调整
4. **策略参数**：可以针对不同标的设置不同的策略参数（需要修改脚本）

---

## 已导入的数据对应的vt_symbol

| 合约 | vt_symbol | 说明 |
|------|-----------|------|
| 上证指数 | `000001.SSE` | 已导入 |
| 深证成指 | `399001.SZSE` | 已导入 |
| 创业板指 | `399006.SZSE` | 已导入 |
| 科创50 | `000688.SSE` | 已导入 |
| 北证50 | `899050.BSE` | 已导入 |
| 恒生指数 | `HSI.GLOBAL` | 已导入 |
| 恒生科技 | `HSTECH.GLOBAL` | 已导入 |
| 标普500 | `GSPC.GLOBAL` | 已导入 |
| 纳斯达克 | `IXIC.GLOBAL` | 已导入 |
| 道琼斯 | `DJI.GLOBAL` | 已导入 |

可以直接在脚本中使用这些vt_symbol进行回测。

