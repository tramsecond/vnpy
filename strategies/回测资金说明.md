# 回测资金说明

## ✅ VnPy回测支持小数手数

### 关键理解

**在VnPy回测中，可以买入任意小数的手数！**

```python
self.buy(price, 0.5)    # ✅ 可以
self.buy(price, 50.25)  # ✅ 可以
self.buy(price, 123.456) # ✅ 可以
```

### 为什么这样设计？

1. **精确模拟资金比例**
   - 策略基于百分比分配资金
   - 小数手数确保精确分配
   - 避免取整导致的误差

2. **适应不同品种**
   - ETF：很多支持1份起买
   - 场外基金：支持任意份额
   - 期货：某些合约支持小数
   - 股票：实盘需要100股整数倍，但回测可以用小数模拟精确比例

3. **保证收益率准确**
   - 小资金也能精确分配
   - 不会因为取整导致实际占用超出预期
   - 收益率计算更准确

## 💰 参考资金的意义

### 当前设置

```python
self.initial_capital = 100000.0  # 10万参考资金
```

### 这个值的作用

- **用于计算比例**：确定每次交易的金额
- **不是最小资金要求**：可以用任意金额回测
- **建议与回测资金一致**：方便理解结果

### 示例

**参考资金：10万**
```python
grid_amount_pct = 5%
每份 = 100000 × 5% = 5000元

股价10元:
买入手数 = 5000 / 10 = 500手

回测资金1万:
买入手数 = 500手（但实际资金只有1万，会有限制）

回测资金10万:
买入手数 = 500手（刚好匹配参考资金）

回测资金100万:
买入手数 = 500手（相对来说更保守）
```

## 🔍 小资金"爆仓"的真实原因

### 之前的误解

~~"因为不能买小数手数，所以取整后资金占用翻倍"~~ ❌

### 真实原因

**资金管理逻辑问题 - 已修复！**

之前的bug：
```python
self.trend_position += trend_volume  # ❌ 累加，导致重复计算
```

修复后：
```python
self.trend_position = trend_volume   # ✅ 赋值，正确记录
```

其他可能原因：
1. **资金占用超过100%**
   - 网格 + 趋势的总资金分配超过初始资金
   - 现在已添加检查确保总占用 ≤ 100%

2. **手续费和滑点**
   - 频繁交易会消耗资金
   - 但这是正常的，不是bug

3. **参数设置不合理**
   - `max_hold_units` 太大
   - `grid_amount_pct` + `trend_position_pct` > 100%

## 📊 不同资金下的回测效果

### 小资金（1万）

```
参考资金: 10万
回测资金: 1万

每份: 5000元
股价10元: 买入500手

问题:
- 第1次买入500手 = 5000元，占用50%
- 理论上可以买18份 = 90000元
- 但实际只有10000元 → 第2次买入就可能不够

解决:
- 方案1: 将回测资金也设为10万（推荐）
- 方案2: 将参考资金改为1万（但其他大资金回测会受影响）
```

### 匹配资金（10万）

```
参考资金: 10万
回测资金: 10万

完美匹配！理论和实际一致。
```

### 大资金（100万）

```
参考资金: 10万
回测资金: 100万

每份: 5000元
资金利用率: 90000 / 1000000 = 9%

特点:
- 更保守
- 大部分资金闲置
- 但收益率的百分比是准确的
```

## 💡 最佳实践

### 1. 统一参考资金和回测资金

**推荐配置：**
```python
# 策略中
self.initial_capital = 100000.0

# 回测设置
初始资金: 100,000
```

### 2. 关注收益率而非绝对金额

```
✅ 年化收益率: 15%
✅ 最大回撤: -8%
✅ 夏普比率: 1.5

❌ 总收益: 15000元（这个值取决于初始资金）
```

### 3. 小资金回测的正确方法

**如果一定要用小资金回测：**

方案A：调整参考资金
```python
self.initial_capital = 10000.0  # 改为1万
```

方案B：调整策略参数
```python
grid_amount_pct = 10.0    # 提高到10%
max_hold_units = 8        # 减少到8份
trend_position_pct = 20.0 # 提高到20%
# 总计: 80% + 20% = 100%
```

### 4. 验证资金是否够用

在回测日志中检查：
```
✅ "网格买入: 500.00手" - 正常
✅ "趋势买入: 1000.50手" - 正常
✅ "总占用:90000/100000" - 正常

⚠️ "会超过100%资金，跳过" - 资金不够！
⚠️ 大量交易被跳过 - 需要调整参数！
```

## ⚠️ 重要提醒

### 回测 vs 实盘

| 项目 | 回测 | 实盘 |
|------|------|------|
| 手数精度 | 任意小数 | 取决于品种 |
| 股票 | 可以0.5手 | 必须100股整数倍 |
| ETF | 可以0.5手 | 大多数1份起 |
| 场外基金 | 任意 | 任意 |
| 期货 | 任意 | 取决于合约 |

### 实盘化考虑

如果将策略用于实盘，需要添加取整逻辑：

```python
# 实盘版本示例
buy_volume = self.grid_amount_per_unit / close_price

# 根据品种进行取整
if 品种 == "股票":
    buy_volume = int(buy_volume / 100) * 100  # 100股整数倍
elif 品种 == "某些ETF":
    buy_volume = int(buy_volume)  # 1份整数倍
# else: 不取整（场外基金等）

if buy_volume > 0:
    self.buy(close_price, buy_volume)
```

但在回测阶段，**不需要取整**，保持小数精度更准确！

## 🎯 总结

1. ✅ **VnPy回测完全支持小数手数**
2. ✅ **不需要担心取整问题**
3. ✅ **小资金"爆仓"是资金管理bug，已修复**
4. ✅ **推荐使用10万作为参考资金和回测资金**
5. ✅ **关注收益率百分比，不是绝对金额**
6. ⚠️ **实盘时需要根据品种规则取整**

**现在策略已恢复小数手数支持，小资金也能正常回测了！** 🎉

