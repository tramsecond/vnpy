# 爆仓问题诊断与解决

## 🐛 发现的Bug

### Bug 1: 趋势持仓累加问题 ✅ 已修复

**问题代码**：
```python
self.trend_position += trend_volume  # ❌ 累加导致持仓失控
```

**现象**：
- 第1次趋势买入：10,000元 → 持仓A
- 卖出
- 第2次趋势买入：10,000元 → 持仓变成A+B（应该只是B）
- 多次后：持仓远超100%资金 → **爆仓！**

**修复**：
```python
self.trend_position = trend_volume  # ✅ 赋值，每次重新计算
```

## 🔍 爆仓的可能原因

从你的回测图表可以看出：
1. ✅ 有交易记录（每日盈亏有数据）
2. ✅ 账户净值曾达到50万（说明策略盈利过）
3. ❌ 最终净值归零（爆仓）

### 原因1：持仓累加Bug（最可能）

多次趋势买入导致实际持仓远超计划：
- 计划：10%资金 = 10,000元
- 实际：累加10次 = 100,000元（超出本金）
- 结果：一次小跌幅就爆仓

### 原因2：策略本身问题

如果修复Bug后仍爆仓，可能是：
- 技术指标参数不适合这个品种
- 市场环境不适合这个策略
- 止损机制缺失

### 原因3：价格数据问题

检查是否有：
- 价格突然跳变
- 停牌复牌导致的价格缺口
- 数据错误

## 🔧 如何测试修复效果

### 1. 先用极小仓位测试

```python
grid_amount_pct = 2.0      # 每份2% （极小）
max_hold_units = 5         # 最多5份 = 10%
trend_position_pct = 5.0   # 趋势5%
# 总计：15%资金，即使bug也不容易爆仓
```

### 2. 观察日志

重点看：
```
✅ "趋势买入信号，买入X手"  → 记录X的值
✅ "趋势卖出信号，卖出Y手"  → Y应该等于X

❌ 如果Y > X → 说明持仓累加了！
```

### 3. 检查持仓变化

```
买入1: 买入100手
卖出1: 卖出100手 ✅

买入2: 买入100手
卖出2: 卖出200手 ❌ 累加bug！
```

### 4. 逐步增加仓位

确认修复后，再增加到：
```python
grid_amount_pct = 5.0
max_hold_units = 18
trend_position_pct = 10.0
```

## 📊 回测后检查清单

### 正常情况

- [x] 总交易日 > 0
- [x] 有交易记录
- [x] 结束资金 > 0
- [x] 账户净值曲线平滑（没有突然归零）
- [x] 日志中趋势买入/卖出数量匹配

### 异常情况需排查

- [ ] 结束资金 = 0 → **爆仓**
- [ ] 净值曲线突然归零 → 某笔交易有问题
- [ ] 趋势卖出数量 > 买入数量 → 持仓累加bug
- [ ] 日志中大量"资金不足" → 资金占用计算错误

## 🛡️ 防爆仓的其他建议

### 1. 添加最大回撤止损

```python
max_drawdown_pct = 30.0  # 最大回撤30%就停止交易
```

### 2. 动态调整仓位

市场波动大时减少仓位：
```python
if 波动率 > 阈值:
    grid_amount_pct *= 0.5  # 减半
```

### 3. 分批建仓

不要一次性买满：
```python
max_hold_units = 18
# 但可以设置初始只买入3份，逐步加仓
```

### 4. 保留现金缓冲

```python
# 不要用满100%，保留20%现金
grid_amount_pct * max_hold_units + trend_position_pct = 80%
```

## 🔬 如果修复后还是爆仓

### 步骤1：导出详细日志

在策略中添加更详细的日志：
```python
self.write_log(f"当前持仓: 网格{self.grid_units}份, 趋势{self.trend_position:.2f}手")
self.write_log(f"理论资金占用: {used_capital:.2f}")
```

### 步骤2：对比单标的回测

用内置的AtrRsiStrategy回测同一品种：
- 如果也爆仓 → 品种问题或数据问题
- 如果不爆仓 → 我们策略的问题

### 步骤3：检查品种特性

某些品种不适合这个策略：
- 高波动品种（如期货）
- 长期单边下跌品种
- 流动性差的品种

### 步骤4：调整策略参数

尝试更保守的参数：
```python
grid_size_pct = 3.0          # 网格间距加大
required_profit_pct = 3.0    # 盈利目标加大
max_hold_units = 10          # 最大份数减少
```

## ⚡ 快速测试

修复后，先用这个极保守配置测试：

```python
# 极保守配置（不容易爆仓）
grid_amount_pct = 3.0
max_hold_units = 5          # 5 × 3% = 15%
trend_position_pct = 5.0    # 5%
# 总计：20%资金
```

如果这个配置都爆仓，说明：
1. 还有其他bug
2. 或者数据有严重问题
3. 或者这个品种极不适合这个策略

## 📞 需要更多帮助？

如果修复后还是爆仓，请提供：
1. 完整的日志输出
2. 回测的品种代码
3. 回测的时间范围
4. 使用的策略参数

这样我可以更准确地诊断问题。

