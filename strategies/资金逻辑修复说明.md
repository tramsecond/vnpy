# èµ„é‡‘é€»è¾‘ä¿®å¤è¯´æ˜Ž

## ðŸ” å‘çŽ°çš„é—®é¢˜

é€šè¿‡å¯¹æ¯”æˆäº¤å’Œå§”æ‰˜è®°å½•ï¼Œå‘çŽ°äº†ä»¥ä¸‹å…³é”®é—®é¢˜ï¼š

### 1. **`cancel_all()` å¯¼è‡´è®¢å•è¢«æ’¤é”€**

**é—®é¢˜**ï¼š
```python
def on_bar(self, bar: BarData):
    self.cancel_all()  # âš ï¸ æ¯ä¸ªbaréƒ½æ’¤é”€æ‰€æœ‰è®¢å•
```

**å½±å“**ï¼š
- è¶‹åŠ¿å–å‡ºä¿¡å·å‘å‡ºåŽï¼Œåˆ›å»ºçš„å¸‚ä»·å•å¯èƒ½åœ¨ä¸‹ä¸€ä¸ªbarè¢«æ’¤é”€
- å¯¼è‡´åº”è¯¥æˆäº¤çš„è®¢å•æ²¡æœ‰æˆäº¤
- å§”æ‰˜è®°å½•ä¸­å‡ºçŽ°å¤šæ¡"å·²æ’¤é”€"è®°å½•

**ä¿®å¤**ï¼š
```python
def on_bar(self, bar: BarData):
    # âœ… ç§»é™¤cancel_all()
    # åŽŸå§‹ç­–ç•¥ä¸ä½¿ç”¨æŒ‚å•æœºåˆ¶ï¼Œè€Œæ˜¯ç›´æŽ¥æ‰§è¡Œä¹°å–
```

### 2. **è¶‹åŠ¿èµ„é‡‘åˆ†é…ä¸ŽåŽŸå§‹ç­–ç•¥ä¸ä¸€è‡´**

**åŽŸå§‹ç­–ç•¥**ï¼ˆtrade_grid_trend_combined_profit_split_fixed.pyï¼‰ï¼š
```python
# ä½¿ç”¨ **æ‰€æœ‰å‰©ä½™çŽ°é‡‘** ä¹°å…¥è¶‹åŠ¿
total_buy_amount = cash  # æ‰€æœ‰çŽ°é‡‘ï¼
trend_position = total_buy_amount / trend_buy_price
cash = 0
```

**ä¹‹å‰çš„VnPyç­–ç•¥**ï¼š
```python
# ä½¿ç”¨å›ºå®š10%çš„èµ„é‡‘
trend_cash = self.initial_capital * 0.10
trend_volume = trend_cash / close_price
```

**ä¿®å¤**ï¼š
```python
# âœ… ä½¿ç”¨æ‰€æœ‰å‰©ä½™çŽ°é‡‘ï¼ˆä¸ŽåŽŸå§‹ç­–ç•¥ä¸€è‡´ï¼‰
if self.cash > 0:
    trend_volume = self.cash / close_price
    self.buy(close_price, trend_volume)
    self.cash = 0
```

### 3. **ç¼ºå°‘çŽ°é‡‘è·Ÿè¸ªæœºåˆ¶**

**é—®é¢˜**ï¼š
- åŽŸå§‹ç­–ç•¥ç»´æŠ¤ä¸€ä¸ª`cash`å˜é‡ï¼Œéšç€æ¯æ¬¡ä¹°å–åŠ¨æ€æ›´æ–°
- VnPyç­–ç•¥ä¹‹å‰æ²¡æœ‰è·Ÿè¸ªçŽ°é‡‘ï¼Œæ— æ³•å‡†ç¡®è®¡ç®—"å‰©ä½™çŽ°é‡‘"

**ä¿®å¤**ï¼š
```python
# ç­–ç•¥å˜é‡ä¸­æ–°å¢ž
cash = 0.0  # å‰©ä½™çŽ°é‡‘

# åˆå§‹åŒ–æ—¶
self.cash = self.initial_capital

# ç½‘æ ¼ä¹°å…¥æ—¶
self.cash -= self.grid_amount_per_unit

# ç½‘æ ¼å–å‡ºæ—¶
self.cash += sell_volume * close_price

# è¶‹åŠ¿ä¹°å…¥æ—¶
trend_volume = self.cash / close_price
self.cash = 0

# è¶‹åŠ¿å–å‡ºæ—¶
self.cash += sell_volume * close_price
```

## âœ… ä¿®å¤å†…å®¹æ€»ç»“

### 1. ç§»é™¤ `cancel_all()`
- ä¸å†æ¯ä¸ªbaræ’¤é”€æ‰€æœ‰è®¢å•
- é¿å…æ­£å¸¸è®¢å•è¢«æ„å¤–æ’¤é”€

### 2. æ·»åŠ çŽ°é‡‘è·Ÿè¸ª
- æ–°å¢ž `self.cash` å˜é‡
- æ¨¡ä»¿åŽŸå§‹ç­–ç•¥çš„çŽ°é‡‘ç®¡ç†é€»è¾‘
- æ¯æ¬¡ä¹°å–éƒ½æ›´æ–°çŽ°é‡‘ä½™é¢

### 3. è¶‹åŠ¿ä¹°å…¥ä½¿ç”¨æ‰€æœ‰å‰©ä½™çŽ°é‡‘
- ä»Žå›ºå®š10%æ”¹ä¸ºä½¿ç”¨**æ‰€æœ‰å‰©ä½™çŽ°é‡‘**
- ä¸ŽåŽŸå§‹ç­–ç•¥å®Œå…¨ä¸€è‡´

### 4. ç½‘æ ¼ä¹°å–æ›´æ–°çŽ°é‡‘
- ç½‘æ ¼ä¹°å…¥ï¼š`cash -= grid_amount_per_unit`
- ç½‘æ ¼å–å‡ºï¼š`cash += sell_amount`

### 5. è¶‹åŠ¿å–å‡ºæ›´æ–°çŽ°é‡‘
- è¶‹åŠ¿å–å‡ºï¼š`cash += sell_amount`
- å–å‡ºåŽçŽ°é‡‘å¯ç”¨äºŽåŽç»­äº¤æ˜“

## ðŸ“Š èµ„é‡‘æµè½¬ç¤ºä¾‹

### åˆå§‹çŠ¶æ€
```
åˆå§‹èµ„é‡‘: 100,000å…ƒ
çŽ°é‡‘: 100,000å…ƒ
ç½‘æ ¼æŒä»“: 0
è¶‹åŠ¿æŒä»“: 0
```

### ç½‘æ ¼ä¹°å…¥ï¼ˆç¬¬1æ¬¡ï¼‰
```
ä¹°å…¥é‡‘é¢: 5,000å…ƒï¼ˆæ¯ä»½5%ï¼‰
çŽ°é‡‘: 100,000 - 5,000 = 95,000å…ƒ
ç½‘æ ¼ä»½æ•°: 1
```

### ç½‘æ ¼ä¹°å…¥ï¼ˆç¬¬2æ¬¡ï¼‰
```
ä¹°å…¥é‡‘é¢: 5,000å…ƒ
çŽ°é‡‘: 95,000 - 5,000 = 90,000å…ƒ
ç½‘æ ¼ä»½æ•°: 2
```

### ç½‘æ ¼å–å‡ºï¼ˆç¬¬1æ¬¡ï¼‰
```
å–å‡ºé‡‘é¢: 5,075å…ƒï¼ˆç›ˆåˆ©1.5%ï¼‰
çŽ°é‡‘: 90,000 + 5,075 = 95,075å…ƒ
ç½‘æ ¼ä»½æ•°: 1
```

### è¶‹åŠ¿ä¹°å…¥
```
ä¹°å…¥é‡‘é¢: 95,075å…ƒï¼ˆæ‰€æœ‰å‰©ä½™çŽ°é‡‘ï¼ï¼‰
çŽ°é‡‘: 0å…ƒ
è¶‹åŠ¿æŒä»“: 95,075 / è‚¡ä»·
ç½‘æ ¼æŒä»“: 5,000å…ƒï¼ˆå†»ç»“ï¼‰
```

### è¶‹åŠ¿å–å‡º
```
å–å‡ºé‡‘é¢: 100,000å…ƒï¼ˆç›ˆåˆ©çº¦5%ï¼‰
çŽ°é‡‘: 0 + 100,000 = 100,000å…ƒ
è¶‹åŠ¿æŒä»“: 0
ç½‘æ ¼æŒä»“: 5,000å…ƒï¼ˆè§£å†»ï¼‰
```

### å†æ¬¡ç½‘æ ¼ä¹°å…¥
```
ä¹°å…¥é‡‘é¢: 5,000å…ƒ
çŽ°é‡‘: 100,000 - 5,000 = 95,000å…ƒ
ç½‘æ ¼ä»½æ•°: 2
```

## ðŸŽ¯ å…³é”®é€»è¾‘

### åŽŸå§‹ç­–ç•¥çš„æ ¸å¿ƒæ€è·¯

1. **ç½‘æ ¼ç­–ç•¥**ï¼š
   - ä½¿ç”¨å›ºå®šé‡‘é¢ï¼ˆ5% * åˆå§‹èµ„é‡‘ï¼‰é€æ­¥å»ºä»“
   - æœ€å¤š18ä»½ = 90%èµ„é‡‘
   - å–å‡ºç›ˆåˆ©åŽï¼ŒçŽ°é‡‘å¢žåŠ ï¼Œå¯ç”¨äºŽè¶‹åŠ¿ä¹°å…¥

2. **è¶‹åŠ¿ç­–ç•¥**ï¼š
   - **ä½¿ç”¨æ‰€æœ‰å‰©ä½™çŽ°é‡‘**ä¹°å…¥
   - è¶‹åŠ¿æŒä»“æœŸé—´ï¼Œç½‘æ ¼äº¤æ˜“å†»ç»“
   - è¶‹åŠ¿å–å‡ºåŽï¼Œæ¢å¤ç½‘æ ¼äº¤æ˜“

3. **èµ„é‡‘ååŒ**ï¼š
   - ç½‘æ ¼ç›ˆåˆ© â†’ çŽ°é‡‘å¢žåŠ  â†’ è¶‹åŠ¿ä¹°å…¥é‡‘é¢å¢žåŠ 
   - è¶‹åŠ¿ç›ˆåˆ© â†’ çŽ°é‡‘å¢žåŠ  â†’ ç½‘æ ¼ä¹°å…¥èƒ½åŠ›å¢žå¼º
   - **å¤åˆ©æ•ˆåº”**ï¼šæ¯æ¬¡ç›ˆåˆ©éƒ½å¢žåŠ åŽç»­äº¤æ˜“çš„èµ„é‡‘é‡

### ä¸ºä»€ä¹ˆè¦ç”¨æ‰€æœ‰çŽ°é‡‘ä¹°è¶‹åŠ¿ï¼Ÿ

**åŽŸå› **ï¼š
1. **æœ€å¤§åŒ–è¶‹åŠ¿æ”¶ç›Š**ï¼šè¶‹åŠ¿ä¿¡å·å‡ºçŽ°æ—¶ï¼Œåº”è¯¥å…¨åŠ›è·Ÿè¿›
2. **èµ„é‡‘åˆ©ç”¨çŽ‡**ï¼šé¿å…å¤§é‡çŽ°é‡‘é—²ç½®
3. **é£Žé™©æŽ§åˆ¶**ï¼šç½‘æ ¼æŒä»“å·²å ç”¨90%ï¼Œå‰©ä½™çŽ°é‡‘é£Žé™©å¯æŽ§
4. **å¤åˆ©æ•ˆåº”**ï¼šä¹‹å‰ç›ˆåˆ©çš„èµ„é‡‘å…¨éƒ¨ç”¨äºŽè¶‹åŠ¿ï¼Œå®žçŽ°å¤åˆ©

**ç¤ºä¾‹**ï¼š
```
åœºæ™¯1ï¼šåˆå§‹çŠ¶æ€
- ç½‘æ ¼18ä»½ = 90,000å…ƒ
- å‰©ä½™çŽ°é‡‘ = 10,000å…ƒ
- è¶‹åŠ¿ä¹°å…¥ = 10,000å…ƒ

åœºæ™¯2ï¼šç½‘æ ¼ç›ˆåˆ©åŽ
- ç½‘æ ¼18ä»½ = 90,000å…ƒï¼ˆæˆæœ¬ï¼‰
- ç½‘æ ¼å·²å–å‡ºç›ˆåˆ© = 2,000å…ƒ
- å‰©ä½™çŽ°é‡‘ = 10,000 + 2,000 = 12,000å…ƒ
- è¶‹åŠ¿ä¹°å…¥ = 12,000å…ƒ âœ…ï¼ˆç›ˆåˆ©ä¹Ÿç”¨ä¸Šäº†ï¼‰

åœºæ™¯3ï¼šè¶‹åŠ¿ç›ˆåˆ©åŽ
- ç½‘æ ¼1ä»½ = 5,000å…ƒ
- è¶‹åŠ¿å·²å–å‡º = 12,000 * 1.10 = 13,200å…ƒ
- å‰©ä½™çŽ°é‡‘ = 13,200å…ƒ
- å†æ¬¡è¶‹åŠ¿ä¹°å…¥ = 13,200å…ƒ âœ…ï¼ˆå¤åˆ©å¢žé•¿ï¼‰
```

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. ä¸ä¼šå¯¼è‡´çˆ†ä»“

**åŽŸå› **ï¼š
- ç½‘æ ¼æœ€å¤šå ç”¨ 90% èµ„é‡‘
- è¶‹åŠ¿åªç”¨å‰©ä½™çŽ°é‡‘ï¼ˆä¸è¶…è¿‡10%+ç›ˆåˆ©ï¼‰
- æ²¡æœ‰å€Ÿæ¬¾æˆ–æ æ†
- æ€»èµ„é‡‘å ç”¨ â‰¤ 100%

### 2. çŽ°é‡‘å¯èƒ½ä¸ºè´Ÿï¼ˆç†è®ºä¸Šï¼‰

**åŽŸå§‹ç­–ç•¥é€»è¾‘**ï¼š
```python
if old_cash >= 0 and cash < 0:
    total_cash_injected += abs(cash)
```

è¿™è¡¨ç¤ºåŽŸå§‹ç­–ç•¥å…è®¸çŽ°é‡‘ä¸ºè´Ÿï¼ˆéœ€è¦è¡¥å……èµ„é‡‘ï¼‰ï¼Œä½†åœ¨VnPyå›žæµ‹ä¸­ï¼š
- å›žæµ‹å¼•æ“Žä¼šè‡ªåŠ¨ç®¡ç†èµ„é‡‘
- å¦‚æžœèµ„é‡‘ä¸è¶³ï¼Œå§”æ‰˜ä¼šè¢«æ‹’ç»
- æ‰€ä»¥å®žé™…ä¸Šä¸ä¼šå‡ºçŽ°è´ŸçŽ°é‡‘

### 3. å›žæµ‹ç»“æžœåº”è¯¥æ›´æŽ¥è¿‘åŽŸå§‹ç­–ç•¥

ä¿®å¤åŽï¼š
- è¶‹åŠ¿ä¹°å…¥é‡‘é¢æ›´å¤§ï¼ˆç”¨æ‰€æœ‰çŽ°é‡‘è€Œä¸æ˜¯å›ºå®š10%ï¼‰
- è¶‹åŠ¿äº¤æ˜“æ¬¡æ•°å¯èƒ½å‡å°‘ï¼ˆå› ä¸ºçŽ°é‡‘ç”¨å®Œéœ€è¦ç­‰ç½‘æ ¼å–å‡ºï¼‰
- è¶‹åŠ¿éƒ¨åˆ†æ”¶ç›Šåº”è¯¥æ›´é«˜
- æ•´ä½“æ”¶ç›Šåº”è¯¥æ›´æŽ¥è¿‘åŽŸå§‹ç­–ç•¥çš„ç»“æžœ

## ðŸ“ æµ‹è¯•å»ºè®®

### 1. å¯¹æ¯”åŽŸå§‹ç­–ç•¥ç»“æžœ

ä½¿ç”¨ç›¸åŒçš„æ•°æ®å’Œå‚æ•°ï¼š
- åŽŸå§‹ç­–ç•¥ï¼š`trade_grid_trend_combined_profit_split_fixed.py`
- VnPyç­–ç•¥ï¼š`grid_trend_strategy.py`

å¯¹æ¯”æŒ‡æ ‡ï¼š
- æ€»æ”¶ç›ŠçŽ‡
- è¶‹åŠ¿äº¤æ˜“æ¬¡æ•°
- ç½‘æ ¼äº¤æ˜“æ¬¡æ•°
- æœ€å¤§å›žæ’¤
- å¤æ™®æ¯”çŽ‡

### 2. æŸ¥çœ‹æ—¥å¿—

é‡ç‚¹å…³æ³¨ï¼š
- "è¶‹åŠ¿ä¹°å…¥ä¿¡å·ï¼Œä½¿ç”¨æ‰€æœ‰å‰©ä½™çŽ°é‡‘" - ç¡®è®¤é‡‘é¢æ˜¯å¦åˆç†
- "çŽ°é‡‘=" - ç¡®è®¤çŽ°é‡‘ä½™é¢æ˜¯å¦æ­£ç¡®æ›´æ–°
- æ˜¯å¦è¿˜æœ‰"å·²æ’¤é”€"çš„å§”æ‰˜

### 3. æ£€æŸ¥æˆäº¤è®°å½•

- è¶‹åŠ¿ä¹°å…¥çš„æ•°é‡æ˜¯å¦è¿œå¤§äºŽä¹‹å‰ï¼ˆå› ä¸ºç”¨äº†æ‰€æœ‰çŽ°é‡‘ï¼‰
- æ‰€æœ‰è¶‹åŠ¿å–å‡ºä¿¡å·æ˜¯å¦éƒ½æˆäº¤äº†
- æ²¡æœ‰å¼‚å¸¸çš„æ’¤å•è®°å½•

## ðŸŽ‰ é¢„æœŸæ”¹è¿›

1. âœ… **æ¶ˆé™¤æ’¤å•é—®é¢˜**ï¼šæ‰€æœ‰è®¢å•æ­£å¸¸æˆäº¤
2. âœ… **èµ„é‡‘é€»è¾‘ä¸€è‡´**ï¼šä¸ŽåŽŸå§‹ç­–ç•¥å®Œå…¨ç›¸åŒ
3. âœ… **æ”¶ç›ŠçŽ‡æ›´å‡†ç¡®**ï¼šå°èµ„é‡‘ä¹Ÿèƒ½æ­£å¸¸è¿è¡Œ
4. âœ… **å¤åˆ©æ•ˆåº”**ï¼šç›ˆåˆ©èµ„é‡‘å……åˆ†åˆ©ç”¨

çŽ°åœ¨é‡æ–°æµ‹è¯•ï¼Œç»“æžœåº”è¯¥ä¸ŽåŽŸå§‹ç­–ç•¥é«˜åº¦ä¸€è‡´ï¼ðŸš€

