# 网格+趋势组合策略说明

## 策略概述

这是一个将网格策略和趋势跟踪策略相结合的复合策略，从原Python回测项目迁移到VnPy平台。

## 策略逻辑

### 1. 默认状态：网格策略
- **初始底仓**：策略启动后先买入1份底仓
- **网格买入**：价格从参考价下跌1.5%时，买入1份（每份固定金额）
- **网格卖出**：当某份持仓盈利达到1.5%时，卖出该份
- **动态参考价**：参考价会随着价格创新高而更新

### 2. 趋势状态：趋势跟踪
- **趋势买入**：当综合判断为"买入信号"时：
  - 冻结网格持仓（不再执行网格交易）
  - 使用剩余资金全仓买入
- **趋势卖出**：当综合判断为"卖出信号"时：
  - 清空所有趋势持仓
  - 恢复网格策略交易

### 3. 技术指标系统

#### SuperTrend (趋势跟踪)
- **参数**：ATR周期=10, 倍数=3.0
- **信号**：
  - 方向=1：买入/持有
  - 方向=-1：卖出/谨慎观望

#### QQE MOD (动量指标)
- **参数**：
  - RSI周期=6, 平滑=5
  - QQE因子=3.0, 阈值=3.0
  - 布林带周期=50, 倍数=0.35
- **信号**：看多/看空/中性

#### Trend A-V2 (平滑Heikin Ashi)
- **参数**：EMA周期=9
- **信号**：上升/下降趋势

### 4. 综合判断逻辑

根据三个指标的组合判断：

| SuperTrend | QQE MOD | Trend A-V2 | 综合判断 |
|-----------|---------|------------|---------|
| 持有 | - | - | 持有信号 |
| 谨慎观望 | - | - | 谨慎观望信号 |
| 买入 | 看多 | 上升 | **买入信号** (进入趋势) |
| 卖出 | 看空 | 下降 | **卖出信号** (退出趋势) |
| 买入/看多/上升 (任一) | - | - | 看多信号 |
| 卖出/看空/下降 (任一) | - | - | 看空信号 |
| 其他 | - | - | 中性 |

## 策略参数

### SuperTrend参数
- `supertrend_length`: ATR周期 (默认10)
- `supertrend_multiplier`: ATR倍数 (默认3.0)

### QQE MOD参数
- `qqe_rsi_length`: RSI周期 (默认6)
- `qqe_rsi_smoothing`: RSI平滑周期 (默认5)
- `qqe_factor`: QQE因子 (默认3.0)
- `qqe_threshold`: 信号阈值 (默认3.0)
- `qqe_bollinger_length`: 布林带周期 (默认50)
- `qqe_bollinger_mult`: 布林带倍数 (默认0.35)

### Trend A-V2参数
- `trend_a_period`: EMA平滑周期 (默认9)

### 网格策略参数
- `grid_size_pct`: 网格间距百分比 (默认1.5%)
- `grid_amount_pct`: 每份网格占初始资金的百分比 (默认4%，即每份占用4%的资金)
- `min_hold_units`: 最小持仓份数 (默认1)
- `max_hold_units`: 最大持仓份数 (默认10，达到后不再买入)
- `required_profit_pct`: 目标盈利百分比 (默认1.5%)
- `trend_position_pct`: 趋势买入时使用的资金百分比 (默认50%，即使用初始资金的50%)

**⚠️ 重要改进**：
- ✅ 使用百分比而非固定金额，收益率不受初始资金影响
- ✅ 网格达到最大份数后不再买入，避免资金不足
- ✅ 趋势买入使用固定百分比，不会用完所有资金

## 与原策略的差异

### 主要差异
1. **资金管理**：
   - 原策略：支持无限资金池，可以透支
   - VnPy版本：使用**基于初始资金百分比**的仓位管理，收益率不受初始资金影响

2. **数据源**：
   - 原策略：基于Excel文件中预计算的`综合判断`列
   - VnPy版本：实时计算技术指标和综合判断

3. **持仓管理**：
   - 原策略：记录每份网格的买入价格和数量
   - VnPy版本：简化为记录网格份数和买入价格列表

### 使用建议

1. **初始资金**：
   - 💡 **关键优势**：由于使用百分比仓位管理，初始资金大小**不影响收益率**
   - 可以使用任意初始资金（10万、50万、100万都可以）
   - 策略内部使用参考资金100,000元来计算比例
   - 例如：`grid_amount_pct=5%` 表示每份占用5%资金（参考100,000元就是5,000元/份）

2. **仓位计算示例**（新版本，更安全）：
   - 如果 `grid_amount_pct=4%`，`max_hold_units=10`，`trend_position_pct=50%`
   - 网格最多占用：4% × 10 = 40%资金
   - 趋势最多占用：50%资金
   - 总计：40% + 50% = 90%资金（留有10%安全余地）
   - ✅ **不会爆仓**：总资金占用控制在合理范围内

3. **合约乘数**：设置为1（因为策略内部已处理金额计算）

4. **手续费率**：根据实际交易成本设置（建议0.03%）

5. **滑点**：建议设置适当的滑点以模拟真实交易

6. **回测时间**：建议使用至少1年以上的数据

## 测试步骤

1. **启动VnPy**：
```bash
cd D:\vnpy\vnpy
python run.py
```

2. **打开CTA回测**

3. **选择策略**：`GridTrendStrategy`

4. **设置参数**：
   - 合约代码：如 `000001.SZSE`
   - 时间周期：日线
   - 初始资金：任意（例如100000，收益率不受影响）
   - 合约乘数：1
   - `grid_amount_pct`：5（每份占用5%资金）
   - 其他参数使用默认值

5. **开始回测**

## 注意事项

⚠️ **重要提示**：

1. ✅ **收益率与初始资金无关**：由于使用百分比仓位管理，无论初始资金是10万还是100万，收益率都相同
2. 策略在震荡市场表现较好，在单边快速下跌市场可能有较大回撤
3. 建议先在回测中测试，确认参数合理后再考虑实盘
4. 实盘前需要进一步优化资金管理和风险控制
5. 网格份数和百分比的设置很关键：
   - `grid_amount_pct`太小：资金利用率低
   - `grid_amount_pct`太大：可能快速达到最大份数
   - `max_hold_units`太小：限制了网格策略的灵活性
   - `max_hold_units`太大：可能占用过多资金，影响趋势交易

## 后续优化方向

1. **资金管理**：根据账户实际可用资金动态调整网格金额
2. **止损机制**：添加最大回撤止损
3. **仓位控制**：根据市场波动率动态调整仓位
4. **参数优化**：使用遗传算法等方法优化参数
5. **多周期分析**：结合小时线、日线、周线等多周期信号

## 参考文件

- 原策略文件：`trade/trade_grid_trend_combined_profit_split_fixed.py`
- 数据准备：`trade/data_preparation.py`
- 信号生成：`trade/data_trend.py`

