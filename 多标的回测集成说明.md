# 多标的回测功能集成说明

## 概述

多标的回测功能已经集成到VeighNa主界面中，可以通过**功能菜单**访问。

## 文件说明

1. **`multi_backtest_widget.py`** - 多标的回测Widget核心模块
   - `MultiBacktestWidget`: 主Widget类
   - `BacktestResultTab`: 单个标的的回测结果页签
   - `SummaryTab`: 汇总统计页签

2. **`run.py`** - 已更新的启动脚本
   - 包含 `MainWindowWithMultiBacktest` 类
   - 自动在"功能"菜单中添加"多标的回测"选项

3. **`run_with_multi_backtest.py`** - 独立的启动脚本示例（可选）

## 使用方法

### 方法一：使用更新后的 run.py（推荐）

1. 确保以下文件在同一目录下：
   - `run.py` (已更新)
   - `multi_backtest_widget.py`

2. 运行启动脚本：
   ```bash
   python run.py
   ```

3. 在VeighNa主界面中：
   - 点击菜单栏 **【功能】** 
   - 选择 **【多标的回测】**
   - 即可打开多标的回测窗口

### 方法二：使用独立启动脚本

1. 使用 `run_with_multi_backtest.py`：
   ```bash
   python run_with_multi_backtest.py
   ```

## 功能特点

✅ **集成到主界面**：通过"功能"菜单直接访问，无需单独启动  
✅ **独立窗口**：多标的回测在独立窗口中运行，不影响主界面  
✅ **多页签显示**：每个标的单独一个页签，最后显示汇总统计  
✅ **完整统计**：显示详细的回测统计指标和交互式图表  
✅ **平均值汇总**：自动计算所有标的的平均表现和对比图表

## 界面说明

### 多标的回测窗口

窗口分为三个部分：

1. **配置区域**（顶部）
   - 选择标的（支持多选）
   - 策略选择
   - 周期、日期范围
   - 资金、手续费率

2. **控制按钮**
   - 【开始回测】按钮

3. **结果页签**（底部）
   - 每个标的一个页签
   - 最后一个"汇总统计"页签

### 单个标的页签

- **左侧**：详细统计指标（日期信息、资金盈亏、交易成本、日均数据、绩效评价）
- **右侧**：交互式图表（账户净值、净值回撤、每日盈亏、盈亏分布）

### 汇总统计页签

- **左侧**：汇总表格
  - 平均值：所有标的的统计指标平均值
  - 各标的表现：每个标的的关键指标对比
- **右侧**：对比图表
  - 总收益率对比
  - Sharpe比率对比
  - 最大回撤对比
  - 年化收益对比

## 与现有回测功能的区别

| 特性 | 单标的回测（CTA回测） | 多标的回测 |
|------|---------------------|-----------|
| 访问方式 | 功能 -> CTA回测 | 功能 -> 多标的回测 |
| 标的数量 | 单个 | 多个（同时） |
| 结果展示 | 单个结果 | 多页签 + 汇总 |
| 对比分析 | 无 | 自动对比和汇总 |
| 数据汇总 | 无 | 平均值 + 对比图表 |

## 注意事项

1. **依赖文件**：确保 `multi_backtest_widget.py` 与 `run.py` 在同一目录
2. **WebEngine支持**：
   - 如果安装了 `PySide6-WebEngine`，图表会嵌入在GUI中
   - 如果没有安装，图表会在浏览器中打开
   - 安装命令：`pip install PySide6-WebEngine`
3. **数据要求**：确保数据库中已有对应标的的历史数据
4. **策略支持**：目前默认使用 `AtrRsiStrategy`，可以根据需要修改

## 故障排除

### 问题：菜单中没有"多标的回测"选项

**可能原因**：
- `multi_backtest_widget.py` 文件不存在
- 导入失败

**解决方案**：
- 检查文件是否存在
- 查看控制台是否有错误信息
- 确保文件在同一目录下

### 问题：点击菜单没有反应

**解决方案**：
- 查看控制台错误信息
- 检查依赖模块是否安装（pandas, plotly等）

### 问题：回测失败

**解决方案**：
- 检查数据库中是否有对应标的的数据
- 检查日期范围是否正确
- 查看错误提示信息

## 扩展功能

如果需要自定义功能，可以修改 `multi_backtest_widget.py`：

1. **添加更多策略**：在 `MultiBacktestWidget.init_ui()` 中的 `strategy_combo` 添加
2. **修改可用标的**：修改 `AVAILABLE_SYMBOLS` 列表
3. **自定义统计指标**：修改 `BacktestResultTab.format_statistics()` 方法
4. **修改图表样式**：修改 `BacktestResultTab.create_chart_html()` 方法

## 下一步改进建议

1. 支持自定义策略参数配置
2. 添加结果导出功能（Excel/CSV）
3. 保存和加载回测配置
4. 支持更多策略类型
5. 添加回测结果对比历史记录

